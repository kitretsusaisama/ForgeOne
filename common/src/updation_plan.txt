ğŸ“Œ Objective
Upgrade common/ into an ultra-secure, distributed, resilient local services module powering ForgeOneâ€™s core subsystems.

It must support:

ğŸ” SQLite â†’ Config, auth, API keys, logging index (with sqlcipher)

âš¡ RocksDB â†’ Real-time compressed stream chunks, trace chains, LLM cache

ğŸ“ Sharded Local Storage â†’ Files + DB split across nodes and paths

ğŸ“œ Immutable Audit Trails â†’ Signed logs, snapshot history

âš™ï¸ Stateful Recovery â†’ Checkpointing, restoration, crash-safe

ğŸ“Š Telemetry Layer â†’ Real-time & offline performance metrics

ğŸ¯ Zero Trust Friendly â†’ Minimal exposure, strict crypto/trace checks

ğŸŒ Access Keying System â†’ API keys, GUI tokens, user accounts (offline)

ğŸ“ Structure (Suggested common/ Expansion)
bash
Copy
Edit
common/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ mod.rs                   # DB prelude
â”‚   â”‚   â”œâ”€â”€ sqlite.rs                # Encrypted SQL storage
â”‚   â”‚   â”œâ”€â”€ rocks.rs                 # Zstd-compressed KV sharded DB
â”‚   â”‚   â”œâ”€â”€ model.rs                 # DB-persisted models
â”‚   â”‚   â”œâ”€â”€ access.rs                # Local auth, tokens, keychains
â”‚   â”‚   â””â”€â”€ snapshot.rs              # Restore, checkpoint state
â”‚   â”œâ”€â”€ audit.rs                     # Signed log ingestion
â”‚   â”œâ”€â”€ telemetry.rs                 # Real-time metrics store (to Rocks)
â”‚   â”œâ”€â”€ identity.rs                  # User/device/agent lineage DB-backed
â”‚   â”œâ”€â”€ trust.rs                     # Cache graphs using Rocks
â”‚   â”œâ”€â”€ observer.rs                  # Store LLM explanations + session trace
â”‚   â”œâ”€â”€ diagnostics.rs               # Panic dumps, restart plans
â”‚   â”œâ”€â”€ crypto.rs                    # Ed25519, entropy seal, log signatures
â”‚   â”œâ”€â”€ logging.rs                   # Rolling .log.zst writer
â”‚   â”œâ”€â”€ events.rs                    # Event definitions (ECS-style)
â”‚   â””â”€â”€ prelude.rs                   # Export traits, helpers
âœ… Required Traits / Concepts
Trait	Purpose
Persistable	For types storable in Rocks/SQLite
Compressible	Support for .zst, .xz, .snappy
Auditable	Self-verifiable event chain
CheckPointable	Must implement snapshot/restore
Loggable	Converts system events into signed .log entries
SecureIdentifiable	All identities have trace IDs and signatures
Shardable	Automatically splits into folder-chunks
SelfHealing	Supports recovery after crash/halt
StreamableEvent	Live emit of metrics / logs / errors

ğŸ“¦ Filesystem Layout (Distributed, Sharded, Fast)
bash
Copy
Edit
.forgeone/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ sqlite/
â”‚   â”‚   â””â”€â”€ local.db
â”‚   â”œâ”€â”€ rocks/
â”‚   â”‚   â”œâ”€â”€ node-01/
â”‚   â”‚   â””â”€â”€ node-02/
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ 2025-07-14/
â”‚   â”‚   â””â”€â”€ audit-001.log.zst
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ latest/
â”‚   â””â”€â”€ archive/
â”œâ”€â”€ metrics/
â”‚   â”œâ”€â”€ system.zst
â”‚   â””â”€â”€ perf.csv
â”œâ”€â”€ snapshots/
â”‚   â”œâ”€â”€ session_001/
â”‚   â””â”€â”€ crash_20250714_13-22-15/
ğŸ’» Advanced SQLite Usage
Use sqlcipher for encrypted-at-rest DB

Index logs, API keys, users, config versions

All writes are signed with Ed25519

Full WAL + rollback support

âš¡ Advanced RocksDB Usage
Per-node compression: zstd + lz4

Sharded paths: node-01, node-02, etc.

TTL (time-to-live) per trace segment

LLM cache can be deduplicated

Telemetry traces streamable to WebSocket layer or GUI

ğŸ” Local Access Management
Store the following inside encrypted SQLite:

âœ… User: username, passhash (argon2), scopes

ğŸ”‘ APIKey: web tokens, token rotation

ğŸŒ GUI Token: locally signed bearer token with expiry

ğŸ”’ Keychain: per-device, per-session encryption fingerprint

ğŸ§© Entitlement: RBAC-like per subsystem

ğŸ§  Recovery System
snapshot.rs: implements CheckPointable trait

Every 1/5/15 min, write a full RocksDB + SQLite checkpoint

On crash, verify logs, checksum state, offer restore prompt

Audit trail embedded with each recovery

ğŸ” Audit Logging System
Append-only .log.zst

Uses audit.rs + crypto.rs to:

Sign each log entry

Encrypt full log if configured

Allow tail + verify via CLI or GUI

Log viewer parses logs by span, event, error, context

ğŸš¦ Telemetry Channel
RocksDB stream + WebSocket forwarding

Export metrics:

Latency, throughput

CPU, memory

Event loop status

Snapshot count, log size

GUI uses GET /local/telemetry/stream

âœ… Next Step
You can now scaffold the following:

common/src/db/sqlite.rs

common/src/db/rocks.rs

common/src/db/snapshot.rs

common/src/logging.rs

common/src/db/model.rs